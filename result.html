<!DOCTYPE html>
<html>

<head>
    <title>트위치 OAuth 토큰 얻기</title>
    <link rel='stylesheet' href='./style.css' />
    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const urlSearchParams = new URLSearchParams(window.location.search);
            const params = Object.fromEntries(urlSearchParams.entries());
            const code = params['code'];
            if (!code) return alert('인증에 실패하였습니다!');
            const secret = decodeURI(params['state']).split('|');
            if (!secret || secret.length != 2) return alert('인증에 실패하였습니다!');

            fetch(`https://id.twitch.tv/oauth2/token?client_id=${secret[1]}&client_secret=${secret[0]}&code=${code}&grant_type=authorization_code&redirect_uri=https://${window.location.hostname + window.location.pathname}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then((result) => {
                result.json().then((json) => {
                    console.log(json);

                    document.getElementById('token-result').innerHTML = json['access_token'] ?? '문제가 발생했습니다!';
                });
            })
        });
    </script>
</head>

<body>
    <div id="container">
        <h1>트위치 OAuth 토큰</h1>
        <code id="token-result">기다려도 토큰이 안 나오면 오류가 발생한겁니다.</code>
    </div>
</body>

</html>